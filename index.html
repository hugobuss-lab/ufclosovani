<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Losování zápasníků</title>

    <!-- Bootstrap 5 CSS (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Firebase SDK (verze 11.1.0) -->
    <script type="module">
        // Načteme Firebase moduly přímo v JavaScriptu
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';

        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyBchdjFEa0njLG5xpXWhPMJqq4O34gysNg",
            authDomain: "ufclosovani.firebaseapp.com",
            projectId: "ufclosovani",
            storageBucket: "ufclosovani.firebasestorage.app",
            messagingSenderId: "138751202363",
            appId: "1:138751202363:web:71fcefa92e79a90c9fb81e",
            measurementId: "G-Q4MZ39CYVD"
        };

        // Inicializace Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const allFighters = [
            'Omari Akhmedov', 'Michael Bisping', 'Derek Brunson', 'Jared Canonnier', 'Khamzat Chimaev',
            'Paulo Costa', 'Nick Diaz', 'Dricus Du Plessis', 'Kelvin Gastelum', 'Uriah Hall',
            'Jack Hermansson', 'Kevin Holland', 'Krzysztof Jotko', 'Lyoto Machida', 'Demian Maia',
            'Bo Nickal', 'Alex Pereira', 'Luke Rockhold', 'Yoel Romero', 'Thiago Santos',
            'Anderson Silva', 'Anthony Smith', 'G. St-Pierre', 'Sean Strickland', 'Darren Till',
            'Marvin Vettori', 'Robert Whittaker'
        ];

        let userRole = "";

        // Funkce pro přiřazení role uživatele (user1 nebo user2)
        async function assignUserRole() {
            const docRef = doc(db, "game", "state");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (!data.user1) {
                    await setDoc(docRef, { user1: true }, { merge: true });
                    userRole = "user1";
                } else if (!data.user2) {
                    await setDoc(docRef, { user2: true }, { merge: true });
                    userRole = "user2";
                } else {
                    alert("Hra je již obsazena!");
                }
            } else {
                await setDoc(docRef, { user1: true });
                userRole = "user1";
            }
        }

        // Funkce pro losování bojovníků
        async function drawFighters() {
            let selectedFighters = [];
            let availableFighters = [...allFighters]; // Kopie seznamu bojovníků

            // Losování 8 bojovníků
            for (let i = 0; i < 8; i++) {
                const randomIndex = Math.floor(Math.random() * availableFighters.length);
                selectedFighters.push(availableFighters[randomIndex]);
                availableFighters.splice(randomIndex, 1); // Odstranit vylosovaného bojovníka
            }

            // Uložení vylosovaných bojovníků do Firestore
            const docRef = doc(db, "game", userRole); 
            await setDoc(docRef, { fighters: selectedFighters });
        }

        // Funkce pro losování zápasů
        async function drawMatchups() {
            const docUser1 = await getDoc(doc(db, "game", "user1"));
            const docUser2 = await getDoc(doc(db, "game", "user2"));

            if (docUser1.exists() && docUser2.exists()) {
                const matchups = docUser1.data().fighters.map((fighter, index) => `${fighter} vs. ${docUser2.data().fighters[index]}`);
                await setDoc(doc(db, "game", "matchups"), { matches: matchups });
            }
        }

        // Posluchače pro aktualizaci UI v reálném čase
        onSnapshot(doc(db, "game", "user1"), (doc) => {
            if (doc.exists()) {
                document.getElementById('fighters1').innerText = doc.data().fighters.join(', ');
            }
        });

        onSnapshot(doc(db, "game", "user2"), (doc) => {
            if (doc.exists()) {
                document.getElementById('fighters2').innerText = doc.data().fighters.join(', ');
            }
        });

        onSnapshot(doc(db, "game", "matchups"), (doc) => {
            if (doc.exists()) {
                document.getElementById('matchup').innerText = doc.data().matches.join('\n');
            }
        });

        // Funkce pro resetování dat v Firestore
        async function resetGameData() {
            await deleteDoc(doc(db, "game", "user1"));
            await deleteDoc(doc(db, "game", "user2"));
            await deleteDoc(doc(db, "game", "matchups"));
            await deleteDoc(doc(db, "game", "state"));  // Volitelně vymažte stav hry, pokud potřebujete
        }

        // Přidání posluchačů na tlačítka
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('drawFighterBtn').addEventListener('click', async () => {
                userRole = "user1";
                await drawFighters();
            });

            document.getElementById('drawFighterBtn2').addEventListener('click', async () => {
                userRole = "user2";
                await drawFighters();
            });

            document.getElementById('drawMatchupBtn').addEventListener('click', drawMatchups);

            // Resetování hry
            document.getElementById('resetGameBtn').addEventListener('click', async () => {
                await resetGameData();  // Resetuje data ve Firestore
                window.location.reload(); // Obnoví stránku a resetuje stav
            });
        });
    </script>
</head>
<body class="container mt-4">
    <h1 class="text-center">Losování zápasníků</h1>

    <div class="row justify-content-center">
        <button id="drawFighterBtn" class="btn btn-primary mx-2">Losuj zápasníky pro Uživatele 1</button>
        <button id="drawFighterBtn2" class="btn btn-primary mx-2">Losuj zápasníky pro Uživatele 2</button>
        <button id="drawMatchupBtn" class="btn btn-success mx-2">Vygeneruj zápasy</button>
    </div>

    <div class="row justify-content-center my-4">
        <button id="resetGameBtn" class="btn btn-danger">Resetovat hru</button>
    </div>

    <h2>Zápasníci pro Uživatele 1:</h2>
    <div id="fighters1" class="border p-2 mb-3"></div>

    <h2>Zápasníci pro Uživatele 2:</h2>
    <div id="fighters2" class="border p-2 mb-3"></div>

    <h2>Vygenerované zápasy:</h2>
    <pre id="matchup" class="border p-2"></pre>

    <!-- Bootstrap 5 JS (nepovinné pro většinu interakcí, ale doporučené pro některé komponenty) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js" integrity="sha512-ykZ1QQr0Jy/4ZkvKuqWn4iF3lqPZyij9iRv6sGqLRdTPkY69YX6+7wvVGmsdBbiIfN/8OdsI7HABjvEok6ZopQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
